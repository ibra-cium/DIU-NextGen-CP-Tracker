<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIU NextGen // CP Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        /* --- MODERN TECH THEME --- */
        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: #0f172a; 
            color: #e2e8f0; 
            overflow-x: hidden;
        }
        
        /* BACKGROUND PARTICLES */
        #particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
        
        /* GLASS UI */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        .glass:hover {
            border-color: rgba(99, 102, 241, 0.4);
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.15);
            transform: translateY(-2px);
        }

        /* ANIMATIONS */
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-entry { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        .delay-100 { animation-delay: 0.1s; }
        .delay-200 { animation-delay: 0.2s; }
        
        /* BATCH BUTTONS */
        .batch-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            transition: all 0.2s;
        }
        .batch-btn:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        .batch-active {
            background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
            border-color: transparent;
            color: white;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
        }

        /* TOAST NOTIFICATION */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; }
        .toast {
            background: rgba(15, 23, 42, 0.9);
            border-left: 4px solid #3b82f6;
            color: white;
            padding: 1rem 1.5rem;
            margin-top: 10px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 10px;
            animation: slideInRight 0.3s ease-out;
        }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* INPUTS */
        .tech-input {
            width: 100%;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            outline: none;
            transition: 0.3s;
        }
        .tech-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            background: rgba(15, 23, 42, 0.9);
        }
        
        /* NAV ACTIVE STATE */
        .nav-active { color: #818cf8; text-shadow: 0 0 10px rgba(99, 102, 241, 0.5); }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="selection:bg-indigo-500/30 selection:text-white">

    <!-- CANVAS BACKGROUND -->
    <canvas id="particles"></canvas>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- 2. AI MODAL (Dr. No) -->
    <div id="ai-modal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="toggleAI(false)"></div>
        <div class="relative w-full max-w-3xl bg-slate-900 border border-red-500/30 rounded-lg shadow-[0_0_50px_rgba(220,38,38,0.2)] flex flex-col max-h-[85vh] fade-in overflow-hidden">
            <div class="flex items-center justify-between p-4 border-b border-red-500/20 bg-red-900/10">
                <div class="flex items-center gap-2 text-red-400">
                    <i data-lucide="bot" class="w-5 h-5 animate-pulse"></i>
                    <span id="ai-title" class="font-bold tracking-widest">DR. NO'S LAIR</span>
                </div>
                <button onclick="toggleAI(false)" class="text-gray-500 hover:text-white transition"><i data-lucide="x"></i></button>
            </div>
            <div id="ai-content" class="flex-grow overflow-y-auto p-6 font-mono text-sm space-y-6 bg-black/50">
                <div class="text-center text-gray-600 py-10">
                    <div class="text-4xl mb-4 opacity-30">üïµÔ∏è‚Äç‚ôÇÔ∏è</div>
                    <p class="tracking-widest text-xs text-red-400">I AM LISTENING. DO YOU HAVE CODE?</p>
                </div>
            </div>
            <div class="p-4 border-t border-red-500/20 bg-black relative">
                <textarea id="ai-input" class="w-full bg-gray-900/50 text-red-100 rounded border border-gray-800 focus:border-red-500/50 p-4 pr-28 h-28 resize-none outline-none text-sm placeholder-gray-600 font-mono transition-all focus:bg-gray-900" placeholder="Paste your Problem Statement AND Code here..."></textarea>
                <button onclick="runAI()" id="ai-btn" class="absolute bottom-6 right-6 bg-red-600 hover:bg-red-500 text-white px-5 py-2 rounded text-xs font-bold uppercase tracking-wider transition-all flex items-center gap-2 shadow-lg shadow-red-900/20">
                    CONSULT <i data-lucide="chevron-right" class="w-3 h-3"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- NAVBAR -->
    <nav class="fixed top-0 w-full z-50 bg-slate-900/80 backdrop-blur-lg border-b border-white/5 transition-all duration-300">
        <div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="showSection('leaderboard')">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-blue-600 flex items-center justify-center shadow-lg shadow-indigo-500/20 group-hover:scale-110 transition-transform">
                    <i data-lucide="cpu" class="text-white w-5 h-5"></i>
                </div>
                <span class="text-2xl font-bold tracking-tight text-white">DIU <span class="text-indigo-400">NextGen</span></span>
            </div>
            
            <div class="hidden md:flex gap-8 text-sm font-bold text-gray-400">
                <button onclick="showSection('leaderboard')" id="nav-leaderboard" class="hover:text-white transition py-2 nav-active">RANKING</button>
                <button onclick="showSection('calendar')" id="nav-calendar" class="hover:text-white transition py-2">CALENDAR</button>
                <button onclick="showSection('resources')" id="nav-resources" class="hover:text-white transition py-2">LIBRARY</button>
            </div>
            
            <div id="public-nav">
                <button onclick="showSection('login')" class="text-gray-400 hover:text-white font-medium px-4 transition">Login</button>
                <button onclick="showSection('register')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2 rounded-lg font-bold transition shadow-lg shadow-indigo-500/30">Join Now</button>
            </div>

            <div id="user-nav" class="hidden flex items-center gap-6">
                <!-- Dr. No Button -->
                <button onclick="toggleAI(true, 'DR_NO')" class="flex items-center gap-2 text-red-400 hover:text-white transition font-bold text-sm border border-red-500/30 px-3 py-1 rounded bg-red-500/10">
                    <i data-lucide="bot" class="w-4 h-4"></i> DR. NO
                </button>

                <button onclick="showSection('topic')" class="text-sm font-bold text-gray-300 hover:text-white flex items-center gap-2 transition"><i data-lucide="bar-chart-2" class="w-4 h-4"></i> YOUR STATS</button>
                
                <button id="admin-btn" onclick="showSection('admin')" class="hidden bg-yellow-500/10 border border-yellow-500/50 text-yellow-400 px-3 py-1 rounded text-xs font-bold uppercase tracking-widest hover:bg-yellow-500/20 transition">‚ö° Admin</button>
                
                <div class="h-6 w-px bg-white/10"></div>
                
                <div class="flex items-center gap-3">
                    <div class="text-right hidden md:block">
                        <div class="text-xs text-gray-400">Logged in as</div>
                        <div id="username-display" class="text-sm font-bold text-indigo-400 font-mono"></div>
                    </div>
                    <button onclick="logout()" class="p-2 hover:bg-white/5 rounded-full transition text-red-400"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                </div>
            </div>
        </div>
    </nav>

    <!-- CONTENT -->
    <main class="container mx-auto p-4 pt-28 max-w-6xl pb-20 relative z-10">

        <!-- 1. LOGIN -->
        <div id="login-section" class="max-w-md mx-auto mt-10 glass rounded-2xl p-10 animate-entry hidden">
            <h2 class="text-3xl font-bold mb-2 text-white">Welcome Back</h2>
            <p class="text-gray-400 mb-8">Enter your credentials to access the system.</p>
            <div class="space-y-5">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Handle</label>
                    <input type="text" id="login-handle" class="tech-input mt-1" placeholder="e.g. IbrahimHero">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Password</label>
                    <input type="password" id="login-pass" class="tech-input mt-1" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button onclick="login()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-indigo-600/30 mt-4">AUTHENTICATE</button>
            </div>
        </div>

        <!-- 2. REGISTER -->
        <div id="register-section" class="max-w-md mx-auto mt-10 glass rounded-2xl p-10 animate-entry hidden">
            <h2 class="text-3xl font-bold mb-2 text-white">Initialize User</h2>
            <p class="text-gray-400 mb-8">Create a new profile in the database.</p>
            <div class="space-y-4">
                <input type="text" id="reg-name" class="tech-input" placeholder="Full Name">
                <input type="email" id="reg-email" class="tech-input" placeholder="DIU Email">
                <input type="text" id="reg-batch" class="tech-input" placeholder="Batch (e.g. Batch-1)">
                <input type="text" id="reg-handle" class="tech-input" placeholder="VJudge Handle (Exact match)">
                <input type="password" id="reg-pass" class="tech-input" placeholder="Set Password">
                <button onclick="register()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-emerald-600/30 mt-2">CREATE ACCOUNT</button>
            </div>
        </div>

        <!-- 3. LEADERBOARD -->
        <div id="leaderboard-section" class="animate-entry">
            <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-6">
                <div>
                    <h2 class="text-5xl font-bold text-white mb-2 tracking-tight">Leaderboard</h2>
                    <p class="text-gray-400 mb-4">Top performing cadets across all rounds.</p>
                    
                    <!-- BATCH SELECTOR -->
                    <div id="batch-container" class="flex flex-wrap gap-2">
                        <!-- JS Injected -->
                    </div>
                </div>
                <div class="flex gap-3">
                    <!-- Dr. No Trigger for Guest/Public -->
                    <button onclick="toggleAI(true, 'DR_NO')" class="bg-red-900/20 border border-red-500/50 hover:bg-red-500/20 text-red-400 px-5 py-2 rounded-lg font-bold transition flex items-center gap-2">
                        <i data-lucide="bot" class="w-4 h-4"></i> Ask Dr. No
                    </button>
                    <button onclick="fetchLeaderboard()" class="bg-slate-800 border border-slate-700 hover:bg-slate-700 text-white px-5 py-2 rounded-lg font-bold transition flex items-center gap-2 shadow-lg">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i> Sync Data
                    </button>
                </div>
            </div>
            
            <div class="glass rounded-xl overflow-hidden border border-slate-700/50">
                <table class="w-full text-left">
                    <thead class="bg-slate-800/50 text-gray-400 text-xs uppercase tracking-wider font-semibold">
                        <tr>
                            <th class="p-5">Rank</th>
                            <th class="p-5">Cadet</th>
                            <th class="p-5 text-center">Batch</th>
                            <th class="p-5 text-right">Total Solved</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body" class="text-sm font-medium"></tbody>
                </table>
            </div>
        </div>

        <!-- 4. TOPIC STATS -->
        <div id="topic-section" class="hidden animate-entry">
            <div class="text-center mb-10">
                <h2 class="text-4xl font-bold text-white mb-2">Performance Analysis</h2>
                <p class="text-gray-400">Deep dive into specific topics for <span id="analyzing-user" class="text-indigo-400 font-bold">...</span></p>
            </div>
            
            <div class="glass p-8 rounded-2xl max-w-3xl mx-auto flex flex-col md:flex-row gap-4 mb-10 border border-slate-700/50">
                <div class="flex-1">
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Target Handle</label>
                    <input id="track-handle" type="text" class="tech-input mt-1 font-mono" placeholder="User Handle">
                </div>
                <div class="md:w-64">
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Topic</label>
                    <select id="track-topic-select" class="tech-input mt-1 cursor-pointer">
                        <option value="" disabled selected>Select Topic</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="fetchTopicStats()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-3 rounded-lg font-bold transition shadow-lg shadow-indigo-600/20 h-[46px]">SCAN</button>
                </div>
            </div>
            
            <div id="topic-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <!-- 5. ADMIN PANEL -->
        <div id="admin-section" class="hidden space-y-8 animate-entry pb-20">
            <h2 class="text-3xl font-bold text-white border-l-4 border-yellow-500 pl-4">Admin Console</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Create Topic -->
                <div class="glass p-6 rounded-xl border-l-4 border-yellow-500">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="folder-plus" class="w-5 h-5 text-yellow-500"></i> Create Topic</h3>
                    <div class="flex flex-col gap-3">
                        <input id="topic-name" type="text" placeholder="Topic Name" class="tech-input">
                        <input id="topic-desc" type="text" placeholder="Description" class="tech-input">
                        <button onclick="createTopic()" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 rounded-lg transition">Initialize Topic</button>
                    </div>
                </div>
                
                <!-- Add Round -->
                <div class="glass p-6 rounded-xl border-l-4 border-purple-500">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="link" class="w-5 h-5 text-purple-500"></i> Link Contest</h3>
                    <div class="flex flex-col gap-3">
                        <input id="round-name" type="text" placeholder="Round Name" class="tech-input">
                        <input id="round-vid" type="text" placeholder="VJudge Contest ID (Big Box)" class="tech-input font-mono text-yellow-400 text-lg">
                        <div class="flex gap-2">
                            <input id="round-tid" type="number" placeholder="Topic ID" class="tech-input w-24 text-center">
                            <button onclick="createRound()" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 rounded-lg transition">Link Round</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Force Sync -->
                <div class="glass p-6 rounded-xl border-l-4 border-red-500">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="refresh-cw" class="w-5 h-5 text-red-500 animate-spin-slow"></i> Force Update</h3>
                    <div class="flex gap-4">
                        <input id="scrape-rid" type="number" placeholder="DB Round ID" class="tech-input">
                        <button onclick="triggerScrape()" class="bg-red-600 hover:bg-red-500 text-white font-bold px-6 rounded-lg transition">SYNC</button>
                    </div>
                    <p id="admin-msg" class="text-xs font-mono text-green-400 mt-3 pl-1"></p>
                </div>
                
                <!-- Promote -->
                <div class="glass p-6 rounded-xl border-l-4 border-blue-500">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="shield-check" class="w-5 h-5 text-blue-500"></i> Promote User</h3>
                    <div class="flex gap-4">
                        <input id="promo-handle" type="text" placeholder="User Handle" class="tech-input">
                        <button onclick="promoteUser()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold px-6 rounded-lg transition">GRANT</button>
                    </div>
                </div>
            </div>

            <!-- CONTENT MANAGEMENT -->
            <h3 class="text-2xl font-bold text-white pt-8 border-t border-white/10">Content Management</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Add Event -->
                <div class="glass p-6 rounded-xl border-l-4 border-emerald-500">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="calendar-plus" class="w-5 h-5 text-emerald-500"></i> Add Event</h3>
                    <div class="flex flex-col gap-3">
                        <input id="cal-title" type="text" placeholder="Event Title" class="tech-input">
                        <input id="cal-date" type="date" class="tech-input text-gray-400">
                        <select id="cal-type" class="tech-input bg-slate-900"><option value="CONTEST">Contest</option><option value="CLASS">Class</option></select>
                        <button onclick="addEvent()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 rounded-lg transition">Add to Calendar</button>
                    </div>
                </div>
                <!-- Add Resource -->
                <div class="glass p-6 rounded-xl border-l-4 border-pink-500">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="book-plus" class="w-5 h-5 text-pink-500"></i> Add Resource</h3>
                    <div class="flex flex-col gap-3">
                        <input id="res-rid" type="number" placeholder="Round ID" class="tech-input">
                        <input id="res-title" type="text" placeholder="Title (e.g. Solution Video)" class="tech-input">
                        <input id="res-url" type="text" placeholder="URL (YouTube/Blog)" class="tech-input">
                        <button onclick="addResource()" class="w-full bg-pink-600 hover:bg-pink-500 text-white font-bold py-2 rounded-lg transition">Attach Resource</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 6. CALENDAR (NEW) -->
        <div id="calendar-section" class="hidden animate-entry">
            <div class="text-center mb-12">
                <h2 class="text-5xl font-bold text-white mb-2">Schedule</h2>
                <p class="text-gray-400">Upcoming Contests & Classes</p>
            </div>
            <div id="calendar-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <!-- 7. RESOURCES (NEW) -->
        <div id="resources-section" class="hidden animate-entry">
            <div class="text-center mb-12">
                <h2 class="text-5xl font-bold text-white mb-2">Knowledge Base</h2>
                <p class="text-gray-400">Classified learning materials.</p>
            </div>
            <div class="max-w-xl mx-auto mb-10">
                <select id="resource-topic-select" onchange="fetchResources()" class="tech-input cursor-pointer text-lg">
                    <option value="" disabled selected>Select a Topic (e.g. Graph)</option>
                </select>
            </div>
            <div id="resource-list" class="space-y-4 max-w-3xl mx-auto"></div>
        </div>

    </main>

    <!-- SCRIPT -->
    <script>
        const API = "http://localhost:8081/api";
        const GEMINI_API_KEY = "AIzaSyDQa-dgdsiEznRiN3fMi0oZKVhIYUM-Kf0"; // üî¥ UPDATED WITH YOUR KEY
        const BATCHES = ["1", "2", "3", "4"]; 
        let currentBatch = BATCHES[0];

        // --- TOAST SYSTEM ---
        function showToast(msg, type='info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            const color = type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6';
            toast.style.borderLeftColor = color;
            toast.innerHTML = `<i data-lucide="${type==='success'?'check-circle':type==='error'?'alert-circle':'info'}" style="color:${color}"></i> <span>${msg}</span>`;
            container.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => { toast.style.opacity='0'; setTimeout(()=>toast.remove(), 300) }, 3000);
        }

        // --- NAVIGATION ---
        function showSection(id) {
            ['login', 'register', 'leaderboard', 'admin', 'topic', 'calendar', 'resources'].forEach(s => 
                document.getElementById(s + '-section').classList.add('hidden')
            );
            document.getElementById(id + '-section').classList.remove('hidden');
            
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('nav-active'));
            const navBtn = document.getElementById('nav-' + id);
            if(navBtn) navBtn.classList.add('nav-active');

            if(id === 'topic' || id === 'resources') loadTopicDropdown();
            if(id === 'leaderboard') fetchLeaderboard();
            if(id === 'calendar') fetchCalendar();
        }

        // --- AUTH ---
        async function login() {
            const h = document.getElementById('login-handle').value;
            const p = document.getElementById('login-pass').value;
            try {
                const res = await fetch(`${API}/auth/login`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({vjudgeHandle:h, password:p})});
                if(res.ok) {
                    const data = await res.json();
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', h);
                    localStorage.setItem('role', data.role);
                    showToast("Login Successful", "success");
                    checkAuth();
                    showSection('leaderboard');
                } else showToast("Invalid Credentials", "error");
            } catch(e) { showToast("Server Offline", "error"); }
        }

        async function register() {
            const body = {
                name: document.getElementById('reg-name').value, email: document.getElementById('reg-email').value,
                batch: document.getElementById('reg-batch').value, vjudgeHandle: document.getElementById('reg-handle').value,
                password: document.getElementById('reg-pass').value
            };
            const res = await fetch(`${API}/auth/register`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
            if(res.ok) { showToast("Registration Success!", "success"); showSection('login'); }
            else showToast("Failed. Handle exists.", "error");
        }

        function checkAuth() {
            const user = localStorage.getItem('user');
            const role = localStorage.getItem('role');
            if(user) {
                document.getElementById('public-nav').classList.add('hidden');
                document.getElementById('user-nav').classList.remove('hidden');
                document.getElementById('username-display').textContent = user;
                if(role === 'ADMIN') document.getElementById('admin-btn').classList.remove('hidden');
            } else {
                document.getElementById('public-nav').classList.remove('hidden');
                document.getElementById('user-nav').classList.add('hidden');
            }
        }
        function logout() { localStorage.clear(); location.reload(); }

        // --- LEADERBOARD ---
        function renderBatchButtons() {
            const c = document.getElementById('batch-container');
            c.innerHTML = BATCHES.map(b => 
                `<button onclick="setBatch('${b}')" class="px-4 py-1.5 rounded-lg text-sm font-bold transition batch-btn ${b===currentBatch ? 'batch-active' : ''}">${b}</button>`
            ).join('');
        }
        function setBatch(b) { currentBatch = b; renderBatchButtons(); fetchLeaderboard(); }

        async function fetchLeaderboard() {
            renderBatchButtons();
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '<tr><td class="p-5 text-gray-500">Syncing data...</td></tr>';
            try {
                const res = await fetch(`${API}/public/leaderboard/${currentBatch}`);
                const data = await res.json();
                if(data.length === 0) { tbody.innerHTML = '<tr><td class="p-5 text-yellow-500">No data found for '+currentBatch+'</td></tr>'; return; }
                
                tbody.innerHTML = data.map((u, i) => {
                    const isBanned = u.status === 'BANNED';
                    const rowClass = isBanned ? 'banned-row' : 'hover:bg-slate-800/50';
                    const rankColor = i === 0 ? 'text-yellow-400' : i === 1 ? 'text-gray-300' : i === 2 ? 'text-amber-600' : 'text-blue-400';
                    return `
                    <tr class="border-b border-slate-700/50 transition ${rowClass} group">
                        <td class="p-5 font-mono ${rankColor} font-bold text-lg">#${i+1}</td>
                        <td class="p-5 font-bold flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full bg-indigo-500/20 flex items-center justify-center text-xs text-indigo-300 font-bold">${u.name.charAt(0)}</div>
                            <div>
                                <div class="text-white group-hover:text-indigo-400 transition">${u.name} ${isBanned?'<span class="banned-tag">BANNED</span>':''}</div>
                                <div class="text-xs text-gray-500 clickable font-mono" onclick="inspectUser('${u.handle}')">@${u.handle}</div>
                            </div>
                        </td>
                        <td class="p-5 text-center"><span class="bg-slate-700 text-gray-300 px-2 py-1 rounded text-xs">${u.batch}</span></td>
                        <td class="p-5 text-right text-emerald-400 font-bold text-xl font-mono">${u.totalSolved}</td>
                    </tr>`;
                }).join('');
            } catch(e) { tbody.innerHTML = '<tr><td class="p-5 text-red-500">Backend Offline</td></tr>'; }
        }

        // --- CALENDAR & RESOURCES ---
        async function fetchCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '<div class="col-span-full text-center text-gray-500">Syncing dates...</div>';
            try {
                const res = await fetch(`${API}/public/calendar`);
                const data = await res.json();
                if(data.length === 0) { grid.innerHTML = '<div class="col-span-full text-center text-gray-500">No upcoming events.</div>'; return; }
                grid.innerHTML = data.map(e => `
                    <div class="glass p-6 rounded-xl border-l-4 ${e.type === 'CONTEST' ? 'border-purple-500' : 'border-emerald-500'}">
                        <div class="text-xs font-bold text-gray-500 mb-1">${e.type}</div>
                        <h3 class="text-xl font-bold text-white mb-2">${e.title}</h3>
                        <div class="flex items-center gap-2 text-gray-400 text-sm"><i data-lucide="calendar" class="w-4 h-4"></i> ${e.eventDate}</div>
                    </div>
                `).join('');
                lucide.createIcons();
            } catch(e) { grid.innerHTML = '<div class="col-span-full text-center text-red-500">Error loading calendar.</div>'; }
        }

        async function fetchResources() {
            const tid = document.getElementById('resource-topic-select').value;
            const list = document.getElementById('resource-list');
            list.innerHTML = '<div class="text-center animate-pulse text-gray-500">Fetching Library...</div>';
            try {
                const res = await fetch(`${API}/public/rounds/${tid}`);
                const rounds = await res.json();
                if(rounds.length === 0) { list.innerHTML = '<div class="text-center text-gray-500">No resources found.</div>'; return; }
                list.innerHTML = rounds.map(r => {
                    const links = r.resources && r.resources.length > 0 
                        ? r.resources.map(l => `<a href="${l.url}" target="_blank" class="block bg-slate-800/50 p-3 rounded border border-slate-700 hover:border-pink-500 flex items-center gap-3 text-sm text-gray-300 hover:text-white transition"><i data-lucide="play-circle" class="w-4 h-4 text-pink-500"></i> ${l.title}</a>`).join('')
                        : '<div class="text-xs text-gray-600 italic p-2">No links attached</div>';
                    return `
                    <div class="glass rounded-xl overflow-hidden border border-slate-700/50">
                        <div class="bg-slate-800/50 p-4 border-b border-slate-700 flex justify-between items-center">
                            <h3 class="font-bold text-lg text-white flex items-center gap-2"><i data-lucide="folder" class="w-4 h-4 text-indigo-400"></i> ${r.name}</h3>
                            <span class="text-xs bg-slate-900 px-2 py-1 rounded text-gray-500 border border-slate-700">ID: ${r.id}</span>
                        </div>
                        <div class="p-4 space-y-2">${links}</div>
                    </div>`;
                }).join('');
                lucide.createIcons();
            } catch(e) { list.innerHTML = '<div class="text-center text-red-500">Requires Backend Update</div>'; }
        }

        // --- STATS ---
        function inspectUser(h) { showSection('topic'); document.getElementById('track-handle').value = h; }
        
        async function loadTopicDropdown() {
            const res = await fetch(`${API}/public/topics`);
            const topics = await res.json();
            const opts = '<option value="" disabled selected>Select Topic</option>' + topics.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            document.getElementById('track-topic-select').innerHTML = opts;
            document.getElementById('resource-topic-select').innerHTML = opts;
        }

        async function fetchTopicStats() {
            const h = document.getElementById('track-handle').value;
            const t = document.getElementById('track-topic-select').value;
            const c = document.getElementById('topic-results');
            document.getElementById('analyzing-user').textContent = h;
            if(!t) return showToast("Select a topic", "error");
            c.innerHTML = '<div class="col-span-full text-center text-gray-500">Scanning...</div>';
            try {
                const res = await fetch(`${API}/public/performance/${h}/${t}`);
                const data = await res.json();
                c.innerHTML = data.map(r => `
                    <div class="glass p-6 rounded-xl border-l-4 border-indigo-500 hover:scale-[1.02] transition">
                        <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Round</div>
                        <div class="text-lg font-bold text-white mb-4 truncate" title="${r.roundName}">${r.roundName}</div>
                        <div class="flex justify-between items-end"><span class="text-3xl font-bold text-emerald-400 font-mono">${r.solvedCount}</span><span class="text-xs text-gray-400 mb-1">SOLVED</span></div>
                    </div>
                `).join('');
            } catch(e) { c.innerHTML = '<div class="col-span-full text-center text-red-500">No data found</div>'; }
        }

        // --- DR NO AI ---
        let aiMode = 'CHAT';
        function toggleAI(show, mode) {
            const modal = document.getElementById('ai-modal');
            if(show) { modal.classList.remove('hidden'); } else modal.classList.add('hidden');
        }

        async function runAI() {
    const input = document.getElementById('ai-input');
    const content = document.getElementById('ai-content');
    const prompt = input.value;
    
    // 1. Validate Input
    if(!prompt) return;

    // 2. UI Updates
    content.innerHTML += `<div class="text-right mb-4"><span class="bg-indigo-900/40 text-indigo-100 px-4 py-2 rounded inline-block border border-indigo-500/30">${prompt}</span></div>`;
    input.value = "";
    
    // 3. Loading Animation
    const loadingId = "load-" + Date.now();
    content.innerHTML += `<div id="${loadingId}" class="text-left text-gray-500 text-xs animate-pulse font-mono mb-4">DR. NO IS ANALYZING...</div>`;
    content.scrollTop = content.scrollHeight;

    const sysPrompt = "You are Dr. No, an elite competitive programming mentor who speaks in riddles. Rules: 1) If the user does not provide code, REFUSE to answer and demand code. 2) NEVER give the full solution. 3) Analyze the provided code for syntax/logic errors. 4) Give hints as cryptic riddles. 5) Suggest complexity improvements. 6) Be sarcastic and strict.";

    try {
        // Log the attempt (hiding part of the key for safety in console)
        console.log("üöÄ Launching Request with Key: " + GEMINI_API_KEY.substring(0, 8) + "...");

        // üî¥ CHANGED: Now using 'gemini-2.5-flash' based on your list
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
            method: 'POST', 
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ contents: [{ parts: [{ text: sysPrompt + "\n\n" + prompt }] }] })
        });

        const data = await res.json();

        // üö® CRITICAL ERROR CHECKING üö®
        if (!res.ok) {
            console.error("‚ùå GOOGLE BLOCKED YOU:", data);
            throw new Error(data.error?.message || `HTTP ${res.status} Error`);
        }

        const reply = data.candidates?.[0]?.content?.parts?.[0]?.text;
        
        if (!reply) {
            console.warn("‚ö†Ô∏è EMPTY RESPONSE (Check Safety Filters):", data);
            throw new Error("Dr. No is silent. (Safety Filter Triggered?)");
        }

        // 4. Success Display
        document.getElementById(loadingId).remove();
        content.innerHTML += `<div class="text-left mb-4"><div class="text-gray-300 bg-gray-900/50 p-4 rounded border-l-2 border-red-500 whitespace-pre-wrap leading-relaxed shadow-lg">${reply}</div></div>`;

    } catch(e) { 
        // 5. Error Display in Chat
        document.getElementById(loadingId).innerHTML = `<span class="text-red-500 font-bold border-b border-red-500">CONNECTION SEVERED</span><br><span class="text-xs text-red-400 font-mono mt-1">${e.message}</span>`;
        console.error("Full System Failure:", e);
    }
    
    content.scrollTop = content.scrollHeight;
}
        // --- ADMIN ---
        async function apiReq(ep, body) {
            const token = localStorage.getItem('token');
            const res = await fetch(`${API}/admin/${ep}`, {method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`}, body:JSON.stringify(body)});
            if(res.ok) showToast("Operation Successful", "success"); else showToast("Operation Failed", "error");
        }
        function createTopic() { apiReq('topic', {name:val('topic-name'), description:val('topic-desc')}); }
        function createRound() { apiReq('round', {name:val('round-name'), vjudgeContestId:val('round-vid'), topicId:val('round-tid')}); }
        function promoteUser() { apiReq(`promote/${val('promo-handle')}`, {}); }
        function addEvent() { apiReq('calendar', {title:val('cal-title'), eventDate:val('cal-date'), type:val('cal-type')}); }
        function addResource() { apiReq('resource', {roundId:val('res-rid'), title:val('res-title'), url:val('res-url')}); }
        
        async function triggerScrape() {
            const token = localStorage.getItem('token');
            const rid = val('scrape-rid');
            document.getElementById('admin-msg').textContent = "Syncing with VJudge...";
            try {
                await fetch(`${API}/admin/refresh-round/${rid}`, {method:'POST', headers:{'Authorization':`Bearer ${token}`}});
                document.getElementById('admin-msg').textContent = "Sync Complete.";
                showToast("Sync Complete", "success");
            } catch(e) { showToast("Sync Failed", "error"); }
        }
        function val(id) { return document.getElementById(id).value; }

        // --- PARTICLES ---
        const canvas = document.getElementById('particles');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        const particles = Array.from({length: 50}, () => ({x: Math.random()*canvas.width, y: Math.random()*canvas.height, vx: (Math.random()-0.5)*0.5, vy: (Math.random()-0.5)*0.5}));
        function animate() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle = 'rgba(99, 102, 241, 0.5)';
            ctx.strokeStyle = 'rgba(99, 102, 241, 0.15)';
            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy;
                if(p.x<0 || p.x>canvas.width) p.vx *= -1;
                if(p.y<0 || p.y>canvas.height) p.vy *= -1;
                ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fill();
                particles.slice(i+1).forEach(p2 => {
                    const d = Math.hypot(p.x-p2.x, p.y-p2.y);
                    if(d<150) { ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(p2.x, p2.y); ctx.stroke(); }
                });
            });
            requestAnimationFrame(animate);
        }
        animate();

        lucide.createIcons();
        checkAuth();
        showSection('leaderboard');
    </script>
</body>
</html>